# GitLab CI/CD 配置文件示例 - 推送到私有镜像仓库
# 复制此文件为 .gitlab-ci.yml 并根据需要修改

stages:
  - build
  - test
  - package

variables:
  # 私有仓库配置（通过 GitLab CI/CD Variables 设置）
  PRIVATE_REGISTRY: "registry.example.com"  # 私有仓库地址
  REGISTRY_USERNAME: "${REGISTRY_USERNAME}"  # 需要在 GitLab 项目中设置
  REGISTRY_PASSWORD: "${REGISTRY_PASSWORD}"  # 需要在 GitLab 项目中设置
  REGISTRY_IMAGE: "${PRIVATE_REGISTRY}/namespace/jib-example"  # 完整镜像路径
  DOCKER_TAG: "${CI_COMMIT_SHORT_SHA}"

# 构建阶段
build:
  stage: build
  image: gradle:8.5-jdk17
  script:
    - ./gradlew build
  artifacts:
    paths:
      - build/libs/
    expire_in: 1 hour

# 测试阶段
test:
  stage: test
  image: gradle:8.5-jdk17
  script:
    - ./gradlew test
  artifacts:
    reports:
      junit: build/test-results/test/**/TEST-*.xml

# 打包并推送到私有仓库
package:
  stage: package
  image: gradle:8.5-jdk17
  before_script:
    # 设置 Jib 认证环境变量
    # 需要在 GitLab 项目设置中添加以下 CI/CD Variables:
    # - REGISTRY_USERNAME: 私有仓库用户名
    # - REGISTRY_PASSWORD: 私有仓库密码或访问令牌
    # 将用户名转换为小写（某些仓库要求小写用户名）
    - export JIB_AUTH_USERNAME=$(echo "${REGISTRY_USERNAME}" | tr '[:upper:]' '[:lower:]')
    - export JIB_AUTH_PASSWORD="${REGISTRY_PASSWORD}"
  script:
    # 构建并推送镜像到私有仓库
    - |
      ./gradlew jib \
        -Pjib.to.image="${REGISTRY_IMAGE}:${DOCKER_TAG}" \
        --info
    # 如果是主分支，同时打上 latest 标签
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        ./gradlew jib \
          -Pjib.to.image="${REGISTRY_IMAGE}:latest" \
          --info
      fi
  only:
    - branches
    - tags
